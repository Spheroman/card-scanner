<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Scanner - Webcam Stream</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .video-section {
            flex: 1;
        }
        .results-section {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        video {
            width: 100%;
            max-width: 640px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        canvas {
            width: 100%;
            max-width: 640px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            margin-top: 10px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .track {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .track-header {
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 10px;
        }
        .match {
            padding: 8px;
            margin: 5px 0;
            background-color: white;
            border-left: 3px solid #4CAF50;
            padding-left: 10px;
        }
        .similarity {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>Card Scanner - Live Webcam Tracking</h1>
    <p>This example demonstrates real-time card tracking and identification using YOLO object tracking.</p>

    <div class="controls">
        <button id="startBtn" onclick="startCamera()">Start Camera</button>
        <button id="stopBtn" onclick="stopCamera()" disabled>Stop Camera</button>
        <button id="resetBtn" onclick="resetTracker()" disabled>Reset Tracker</button>
    </div>

    <div id="status" class="status disconnected">Disconnected</div>

    <div class="container">
        <div class="video-section">
            <h2>Camera Feed</h2>
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>
        <div class="results-section">
            <h2>Detected Cards</h2>
            <div id="results"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let stream = null;
        let intervalId = null;

        // WebSocket server URL (adjust if needed)
        const WS_URL = 'ws://localhost:8000/webcam?top_n=3';
        const FRAME_RATE = 10; // Send 10 frames per second

        async function startCamera() {
            try {
                // Get webcam stream
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                video.srcObject = stream;

                // Wait for video to be ready
                await new Promise(resolve => {
                    video.onloadedmetadata = resolve;
                });

                // Set canvas dimensions to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Connect to WebSocket
                connectWebSocket();

                // Update UI
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('resetBtn').disabled = false;
            } catch (err) {
                alert('Error accessing camera: ' + err.message);
            }
        }

        function stopCamera() {
            // Stop sending frames
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }

            // Close WebSocket
            if (ws) {
                ws.close();
                ws = null;
            }

            // Stop video stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            // Update UI
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('resetBtn').disabled = true;
            updateStatus('Disconnected', false);
            document.getElementById('results').innerHTML = '';
        }

        function connectWebSocket() {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateStatus('Connected', true);

                // Start sending frames
                intervalId = setInterval(sendFrame, 1000 / FRAME_RATE);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.error) {
                    console.error('Server error:', data.error);
                    return;
                }

                if (data.status === 'tracker_reset') {
                    console.log('Tracker reset');
                    return;
                }

                if (data.tracks) {
                    displayResults(data.tracks);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus('Error', false);
            };

            ws.onclose = () => {
                console.log('WebSocket closed');
                updateStatus('Disconnected', false);
                if (intervalId) {
                    clearInterval(intervalId);
                    intervalId = null;
                }
            };
        }

        function sendFrame() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }

            // Draw current video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert to JPEG and encode as base64
            canvas.toBlob((blob) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    // Remove data URL prefix (data:image/jpeg;base64,)
                    const base64 = reader.result.split(',')[1];
                    ws.send(base64);
                };
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.8);
        }

        function resetTracker() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ command: 'reset' }));
                document.getElementById('results').innerHTML = '<p>Tracker reset. All cards will be re-identified.</p>';
            }
        }

        function updateStatus(message, isConnected) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + (isConnected ? 'connected' : 'disconnected');
        }

        function displayResults(tracks) {
            const resultsEl = document.getElementById('results');

            if (tracks.length === 0) {
                resultsEl.innerHTML = '<p>No cards detected</p>';
                return;
            }

            let html = '';
            tracks.forEach(track => {
                html += `<div class="track">`;
                html += `<div class="track-header">Track ID: ${track.track_id}</div>`;
                html += `<div>Box: [${track.box.map(v => v.toFixed(1)).join(', ')}]</div>`;

                if (track.matches && track.matches.length > 0) {
                    html += '<div style="margin-top: 10px;"><strong>Matches:</strong></div>';
                    track.matches.forEach((match, idx) => {
                        html += `<div class="match">`;
                        html += `<div>#${idx + 1} - Card ID: ${match.card_id}</div>`;
                        html += `<div class="similarity">Similarity: ${(match.similarity * 100).toFixed(2)}%</div>`;

                        if (match.details) {
                            html += `<div style="margin-top: 5px; font-size: 0.9em;">`;
                            html += `<div><strong>${match.details.name || 'Unknown'}</strong></div>`;
                            if (match.details.market_price) {
                                html += `<div>Market Price: $${match.details.market_price}</div>`;
                            }
                            html += `</div>`;
                        }
                        html += `</div>`;
                    });
                } else {
                    html += '<div style="margin-top: 10px; color: #999;">Identifying...</div>';
                }

                html += `</div>`;
            });

            resultsEl.innerHTML = html;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>
</html>
